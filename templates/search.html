<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Users</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="page">
        <div class="container">
            <h2>üîç Search Users</h2>

            {% with messages = get_flashed_messages(with_categories=True) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Live Search Input -->
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Type username..." autocomplete="off">
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>

            {% if user %}
            <div class="user-result-card">
                <div class="result-avatar">{{ user.username[0].upper() }}</div>
                <div class="result-info">
                    <h3>{{ user.username }}</h3>
                    <a href="{{ url_for('chat', receiver_id=user.id) }}" class="chat-link">
                        <button class="action-btn primary">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            Start Chat
                        </button>
                    </a>
                </div>
            </div>
            {% endif %}

            <a href="{{ url_for('dashboard') }}">
                <button class="action-btn secondary" style="margin-top: 20px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Back to Dashboard
                </button>
            </a>
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout;

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();

            if (query.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/search-users?q=${encodeURIComponent(query)}`);
                    const users = await response.json();

                    if (users.length === 0) {
                        searchResults.innerHTML = '<div class="search-item no-results">No users found</div>';
                        searchResults.style.display = 'block';
                    } else {
                        searchResults.innerHTML = users.map(user => `
                            <a href="/chat/${user.id}" class="search-item">
                                <div class="search-avatar">${user.username[0].toUpperCase()}</div>
                                <span>${user.username}</span>
                            </a>
                        `).join('');
                        searchResults.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });

        // Hide results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        searchInput.addEventListener('focus', () => {
            if (searchResults.innerHTML && searchInput.value.trim()) {
                searchResults.style.display = 'block';
            }
        });
    </script>
</body>
</html>
