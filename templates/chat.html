<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container">
    <h2>Chat with {{ receiver.username }}</h2>

    {% if session.get("chat_cleared") %}
  <div class="alert success">Chats cleared</div>
  {% set _ = session.pop("chat_cleared") %}
{% endif %}


    <div id="chat-box"
         style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;">
    </div>

    <form id="chat-form">
        <input id="message-input" placeholder="Type message..." required>
        <button type="submit">Send</button>
    </form>
    <form method="POST" action="/delete-chat/{{ receiver.id }}">
    <button style="background:red;">Delete Chat</button>
</form>


    <a href="/search">Back to Search</a>
</div>

<script>
/* STEP A: receiver id (SAFE) */
const receiverId = {{ receiver.id | tojson | safe }};

/* STEP B: load messages */
function loadMessages() {
    fetch(`/messages/${receiverId}`)
        .then(response => response.json())
        .then(data => {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = "";

            data.forEach(msg => {
                const p = document.createElement("p");
                p.innerHTML = `<b>${msg.sender}:</b> ${msg.message}`;
                chatBox.appendChild(p);
            });

            chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(err => console.error("Fetch error:", err));
}

/* STEP C: polling */
setInterval(loadMessages, 200);
loadMessages();

/* STEP D: send message */
document.getElementById("chat-form").addEventListener("submit", function(e) {
    e.preventDefault();

    const input = document.getElementById("message-input");
    const message = input.value.trim();
    if (!message) return;

    fetch(`/chat/${receiverId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `message=${encodeURIComponent(message)}`
    })
    .then(() => {
        input.value = "";
        loadMessages();
    })
    .catch(err => console.error("Send error:", err));
});
</script>

</body>
</html>
